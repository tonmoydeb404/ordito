name: Build Tauri App and Publish to Snap Store

on:
  push:
    tags:
      - "v*" # Trigger on tag pushes like v1.1.0
  workflow_dispatch:

jobs:
  build-snap:
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}

    steps:
      - name: Install snapd
        run: |
          sudo apt update
          sudo apt install -y snapd

      - name: Start snapd service
        run: |
          sudo systemctl start snapd
          sudo systemctl enable snapd

      - name: Install LXD via Snap
        run: |
          sudo snap install lxd

      - name: Initialize LXD
        run: |
          sudo lxd waitready || true
          echo y | sudo lxd init --auto
          sudo lxc network set lxdbr0 ipv6=false

      - name: Install Snapcraft
        run: |
          sudo snap install core
          sudo snap install snapcraft --classic

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Configure npm registry
        run: echo "registry=https://registry.npmjs.org/"  > .npmrc

      - name: Install pnpm globally
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Install Tauri CLI
        run: pnpm add -g @tauri-apps/cli

      - name: Write snap/snapcraft.yaml
        run: |
          cat <<EOF > snap/snapcraft.yaml
          name: ordito
          base: core22
          version: '1.1.0'
          summary: A powerful desktop application for organizing and executing commands
          description: |
            Ordito is a desktop application that allows users to organize and execute commands
            from a convenient system tray interface.

          grade: stable
          confinement: strict

          layout:
            /usr/lib/\$SNAPCRAFT_ARCH_TRIPLET/webkit2gtk-4.1:
              bind: \$SNAP/usr/lib/\$SNAPCRAFT_ARCH_TRIPLET/webkit2gtk-4.1

          apps:
            ordito:
              command: usr/bin/ordito
              desktop: usr/share/applications/ordito.desktop
              extensions: [gnome]
              plugs:
                - home
                - network
                - notifications
                - removable-media
                - x11
                - wayland

          package-repositories:
            - type: apt
              components: [main]
              suites: [jammy]
              key-id: 78E1918602959B9C59103100F1831DDAFC42E99D
              url: http://ppa.launchpad.net/snappy-dev/snapcraft-daily/ubuntu

          parts:
            ordito:
              plugin: dump
              source: .
              build-snaps:
                - node/20/stable
                - rustup/latest/stable
              build-packages:
                - pnpm
                - libwebkit2gtk-4.1-dev
                - build-essential
                - curl
                - wget
                - file
                - libxdo-dev
                - libssl-dev
                - libayatana-appindicator3-dev
                - librsvg2-dev
                - dpkg
              stage-packages:
                - libwebkit2gtk-4.1-0
                - libayatana-appindicator3-1
              override-pull: |
                set -eu
                npm install -g pnpm
                snapcraftctl pull
              override-build: |
                set -eu
                pnpm install
                pnpm build
                pnpm add -g @tauri-apps/cli
                pnpm tauri build --bundle deb
                dpkg -x src-tauri/target/release/bundle/deb/*.deb "\$SNAPCRAFT_PART_INSTALL/"
                sed -i -e "s|Icon=ordito|Icon=/usr/share/icons/hicolor/32x32/apps/ordito.png|g" "\$SNAPCRAFT_PART_INSTALL/usr/share/applications/ordito.desktop"
          EOF

      - name: Build Snap Package
        run: |
          cd snap
          snapcraft --use-lxd

      - name: Upload Snap Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ordito-snap
          path: snap/*.snap

      - name: Push to Snap Store
        run: |
          snapcraft push snap/*.snap --release=stable
